"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("eventemitter3"),t=require("lodash-es/isEqual"),r=require("lodash-es/isObject"),n=require("resource-loader");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=o(e),a=o(t),i=o(r),c=function(e,t){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function u(e,t){function r(){this.constructor=e}c(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}function p(e,t,r,n){var o,s=arguments.length,a=s<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,n);else for(var i=e.length-1;i>=0;i--)(o=e[i])&&(a=(s<3?o(a):s>3?o(t,r,a):o(t,r))||a);return s>3&&a&&Object.defineProperty(t,r,a),a}function l(e,t,r,n){return new(r||(r=Promise))((function(o,s){function a(e){try{c(n.next(e))}catch(e){s(e)}}function i(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){e.done?o(e.value):new r((function(t){t(e.value)})).then(a,i)}c((n=n.apply(e,t||[])).next())}))}function f(e,t){var r,n,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:i(0),throw:i(1),return:i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(s){return function(i){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],n=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,i])}}}function h(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function d(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,s=r.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(n=s.next()).done;)a.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=s.return)&&r.call(s)}finally{if(o)throw o.error}}return a}function m(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(d(arguments[t]));return e}var y,v=function(e){function t(t){var r=e.call(this)||this;return r.started=!1,r.name=r.constructor.componentName,r.__componentDefaultParams=t,r}return u(t,e),t}(s.default);exports.OBSERVER_TYPE=void 0,(y=exports.OBSERVER_TYPE||(exports.OBSERVER_TYPE={})).ADD="ADD",y.REMOVE="REMOVE",y.CHANGE="CHANGE";var g={},b={},E={},O={};function _(e,t){g[e.gameObject.id]||(g[e.gameObject.id]={});var r=g[e.gameObject.id],n=e.name+"_"+t.join(",");if(r[n])return r[n];for(var o=t.length-1,s=e,a=0;a<o;a++)s=s[t[a]];return r[n]={property:s,key:t[o]},r[n]}function x(e){var t=e.systemName,r=e.componentName,n=e.component,o=e.prop,s=e.type;b[t].componentObserver.add({component:n,prop:o,type:s,componentName:r})}function S(e){var t,r,n=e.obj,o=e.key,s=e.prop,c=e.component,u=e.componentName;if(void 0!==n)if(o in n){if(Object.defineProperty(n,"_"+o,{enumerable:!1,writable:!0,value:n[o]}),s.deep&&i.default(n[o]))try{for(var p=h(Object.keys(n[o])),l=p.next();!l.done;l=p.next()){var f=l.value;S({obj:n[o],key:f,prop:s,component:c,componentName:u})}}catch(e){t={error:e}}finally{try{l&&!l.done&&(r=p.return)&&r.call(p)}finally{if(t)throw t.error}}Object.defineProperty(n,o,{enumerable:!0,set:function(e){n["_"+o]!==e&&(n["_"+o]=e,function(e){var t=e.prop,r=e.component,n=e.componentName;for(var o in E){var s=(E[o]||{})[n];s&&s.findIndex((function(e){return a.default(e,t)}))>-1&&x({systemName:o,componentName:n,component:r,prop:t,type:exports.OBSERVER_TYPE.CHANGE})}}({prop:s,component:c,componentName:u}))},get:function(){return n["_"+o]}})}else console.error("prop "+o+" not in component: "+u+", Can not observer")}function w(e,t){for(var r in void 0===t&&(t=e.name),E){(E[r]||{})[t]&&b[r].componentObserver.add({component:e,type:exports.OBSERVER_TYPE.REMOVE,componentName:t})}!function(e){e.gameObject&&delete g[e.gameObject.id]}(e)}function T(e,t){e.constructor.IDEProps||(e.constructor.IDEProps=[]),e.constructor.IDEProps.push(t)}var R=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Transform",t._parent=null,t.inScene=!1,t.children=[],t.position={x:0,y:0},t.size={width:0,height:0},t.origin={x:0,y:0},t.anchor={x:0,y:0},t.scale={x:1,y:1},t.skew={x:0,y:0},t.rotation=0,t}return u(t,e),t.prototype.init=function(e){var t,r;void 0===e&&(e={});try{for(var n=h(["position","size","origin","anchor","scale","skew"]),o=n.next();!o.done;o=n.next()){var s=o.value;Object.assign(this[s],e[s])}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}this.rotation=e.rotation||this.rotation},Object.defineProperty(t.prototype,"parent",{get:function(){return this._parent},set:function(e){e?e.addChild(this):this.parent&&this.parent.removeChild(this)},enumerable:!1,configurable:!0}),t.prototype.addChild=function(e){if(e.parent===this){var t=this.children.findIndex((function(t){return t===e}));this.children.splice(t,1)}else e.parent&&e.parent.removeChild(e);e._parent=this,this.children.push(e)},t.prototype.removeChild=function(e){var t=this.children.findIndex((function(t){return t===e}));t>-1&&(this.children.splice(t,1),e._parent=null)},t.prototype.clearChildren=function(){this.children.length=0},t.componentName="Transform",p([T],t.prototype,"position",void 0),p([T],t.prototype,"size",void 0),p([T],t.prototype,"origin",void 0),p([T],t.prototype,"anchor",void 0),p([T],t.prototype,"scale",void 0),p([T],t.prototype,"skew",void 0),p([T],t.prototype,"rotation",void 0),t}(v),j=0;var N,C=function(){function e(e,t){this._componentCache={},this.components=[],this._name=e,this.id=++j,this.addComponent(R,t)}return Object.defineProperty(e.prototype,"transform",{get:function(){return this.getComponent(R.componentName)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"parent",{get:function(){return this.transform&&this.transform.parent&&this.transform.parent.gameObject},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"name",{get:function(){return this._name},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scene",{get:function(){return this._scene},set:function(e){var t,r;if(this._scene!==e){var n=this._scene;if(this._scene=e,this.transform&&this.transform.children)try{for(var o=h(this.transform.children),s=o.next();!s.done;s=o.next()){s.value.gameObject.scene=e}}catch(e){t={error:e}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}e?e.addGameObject(this):n&&n.removeGameObject(this)}},enumerable:!1,configurable:!0}),e.prototype.addChild=function(t){if(t&&t.transform&&t!==this){if(!(t instanceof e))throw new Error("addChild only receive GameObject");if(!this.transform)throw new Error("gameObject '"+this.name+"' has been destroy");t.transform.parent=this.transform,t.scene=this.scene}},e.prototype.removeChild=function(t){return t instanceof e&&t.parent&&t.parent===this?(t.transform.parent=null,t.scene=null,t):t},e.prototype.addComponent=function(e,t){var r=function(e){return e instanceof v?e.name:e instanceof Function?e.componentName:void 0}(e);if(!this._componentCache[r]){var n;if(e instanceof Function)n=new e(t);else{if(!(e instanceof v))throw new Error("addComponent recieve Component and Component Constructor");n=e}if(n.gameObject)throw new Error("component has been added on gameObject "+n.gameObject.name);return n.gameObject=this,n.init&&n.init(n.__componentDefaultParams),function(e,t){for(var r in void 0===t&&(t=e.name),E)(E[r]||{})[t]&&b[r].componentObserver.add({component:e,type:exports.OBSERVER_TYPE.ADD,componentName:t})}(n,n.name),function(e,t){var r,n;if(void 0===t&&(t=e.name),t&&O[t]){if(!(e&&(o=e,o&&o.constructor&&"componentName"in o.constructor)))throw new Error("component param must be an instance of Component");var o;if(!e.gameObject||!e.gameObject.id)throw new Error("component should be add to a gameObject");try{for(var s=h(O[t]),a=s.next();!a.done;a=s.next()){var i=a.value,c=_(e,i.prop);S({obj:c.property,key:c.key,prop:i,component:e,componentName:t})}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}}}(n,n.name),this.components.push(n),this._componentCache[r]=n,n.awake&&n.awake(),n}},e.prototype.removeComponent=function(e){var t;if("string"==typeof e?t=e:e instanceof v?t=e.name:e.componentName&&(t=e.componentName),"Transform"===t)throw new Error("Transform can't be removed");return this._removeComponent(t)},e.prototype._removeComponent=function(e){var t=this.components.findIndex((function(t){return t.name===e}));if(-1!==t){var r=this.components.splice(t,1)[0];return delete this._componentCache[e],r.onDestroy&&r.onDestroy(),w(r,e),r.gameObject=void 0,r}},e.prototype.getComponent=function(e){var t;return"string"==typeof e?t=e:e instanceof v?t=e.name:e.componentName&&(t=e.componentName),void 0!==this._componentCache[t]?this._componentCache[t]:void 0},e.prototype.remove=function(){if(this.parent)return this.parent.removeChild(this)},e.prototype.destroy=function(){for(var e in Array.from(this.transform.children).forEach((function(e){e.gameObject.destroy()})),this.remove(),this.transform.clearChildren(),this._componentCache)this._removeComponent(e);this.components.length=0},e}(),P=function(){function e(){this.events=[]}return e.prototype.add=function(e){var t=e.component,r=e.prop,n=e.type,o=e.componentName;n===exports.OBSERVER_TYPE.REMOVE&&(this.events=this.events.filter((function(e){return e.component!==t})));var s=this.events.findIndex((function(e){return e.component===t&&a.default(e.prop,r)&&e.type===n}));s>-1&&this.events.splice(s,1),this.events.push({gameObject:t.gameObject,component:t,prop:r,type:n,componentName:o})},e.prototype.getChanged=function(){return this.events},Object.defineProperty(e.prototype,"changed",{get:function(){return this.events},enumerable:!1,configurable:!0}),e.prototype.clear=function(){var e=this.events;return this.events=[],e},e}(),D=function(){function e(e){this.started=!1,this.componentObserver=new P,this.__systemDefaultParams=e,this.name=this.constructor.systemName}return e.prototype.destroy=function(){var e;this.componentObserver=null,this.__systemDefaultParams=null,null===(e=this.onDestroy)||void 0===e||e.call(this)},e}(),I={autoStart:!0,frameRate:60},L=function(){function e(e){var t=this;e=Object.assign({},I,e),this._frameDuration=1e3/e.frameRate,this.autoStart=e.autoStart,this.frameRate=e.frameRate,this._tickers=new Set,this._requestId=null,this._blockTime=0,this._lastTime=Date.now(),this._frameCount=0,this._activeWithPause=!1,this._ticker=function(){t._started&&(t._requestId=requestAnimationFrame(t._ticker),t.update())},this.autoStart&&this.start(),this.bindEvent()}return e.prototype.update=function(){var e,t,r=Date.now();if(r-this._lastTime>=this._frameDuration){var n=r-this._lastTime,o={deltaTime:n,frameCount:++this._frameCount,time:r-this._blockTime,fps:Math.round(1e3/n)};try{for(var s=h(this._tickers),a=s.next();!a.done;a=s.next()){var i=a.value;"function"==typeof i&&i(o)}}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}this._lastTime=r}},e.prototype.add=function(e){this._tickers.add(e)},e.prototype.remove=function(e){this._tickers.delete(e)},e.prototype.start=function(){this._started||(this._lastStopTime>0&&(this._blockTime=this._blockTime+Date.now()-this._lastStopTime,this._lastStopTime=0),this._started=!0,this._lastTime=Date.now(),this._requestId=requestAnimationFrame(this._ticker))},e.prototype.pause=function(){this._started=!1,this._lastStopTime=Date.now()},e.prototype.active=function(){this._activeWithPause||this.start(),this._activeWithPause=!1},e.prototype.background=function(){this._started?this.pause():this._activeWithPause=!0},e.prototype.bindEvent=function(){},e}(),A=function(e){function t(t,r){var n=e.call(this,t,r)||this;return n.gameObjects=[],n.scene=n,n}return u(t,e),t.prototype.addGameObject=function(e){this.gameObjects.push(e),e.transform&&(e.transform.inScene=!0)},t.prototype.removeGameObject=function(e){var t=this.gameObjects.indexOf(e);-1!==t&&(e.transform&&(e.transform.inScene=!1),this.gameObjects.splice(t,1))},t.prototype.destroy=function(){this.scene=null,e.prototype.destroy.call(this),this.gameObjects=null,this.canvas=null},t}(C);exports.LOAD_SCENE_MODE=void 0,(N=exports.LOAD_SCENE_MODE||(exports.LOAD_SCENE_MODE={})).SINGLE="SINGLE",N.MULTI_CANVAS="MULTI_CANVAS";var k=function(e){if((e instanceof D||e instanceof v)&&!e.started){try{e.start&&e.start()}catch(t){e instanceof v?console.error(e.constructor.componentName+" start error",t):console.error(e.constructor.systemName+" start error",t)}e.started=!0}},M=function(e){function t(t){var r,n,o=void 0===t?{}:t,s=o.autoStart,a=void 0===s||s,i=o.frameRate,c=void 0===i?120:i,u=o.systems,p=o.needScene,l=void 0===p||p,f=e.call(this)||this;if(f.playing=!1,f.started=!1,f.multiScenes=[],f.systems=[],f.ticker=new L({autoStart:!1,frameRate:c}),f.initTicker(),u&&u.length)try{for(var d=h(u),m=d.next();!m.done;m=d.next()){var y=m.value;f.addSystem(y)}}catch(e){r={error:e}}finally{try{m&&!m.done&&(n=d.return)&&n.call(d)}finally{if(r)throw r.error}}return l&&f.loadScene(new A("scene")),a&&f.start(),f}return u(t,e),Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},set:function(e){this._scene=e},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"gameObjects",{get:function(){return function(e){var t,r,n,o=(null===(n=null==e?void 0:e.scene)||void 0===n?void 0:n.gameObjects)||[],s=null==e?void 0:e.multiScenes.map((function(e){return e.gameObjects})),a=[];try{for(var i=h(s),c=i.next();!c.done;c=i.next())a=m(a,c.value)}catch(e){t={error:e}}finally{try{c&&!c.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}return m(o,a)}(this)},enumerable:!1,configurable:!0}),t.prototype.addSystem=function(e,t){var r;if(e instanceof Function)r=new e(t);else{if(!(e instanceof D))return void console.warn("can only add System");r=e}if(!this.systems.find((function(e){return e.constructor===r.constructor}))){r.game=this,r.init&&r.init(r.__systemDefaultParams),function(e,t){E[t.systemName]=t.observerInfo,b[t.systemName]=e}(r,r.constructor),function(e){var t,r,n,o,s=[];e instanceof Array?s.push.apply(s,m(e)):s.push(e);try{for(var i=h(s),c=i.next();!c.done;c=i.next()){var u=c.value;for(var p in u.observerInfo){O[p]=O[p]||[];var l=O[p],f=function(e){-1===l.findIndex((function(t){return a.default(t,e)}))&&O[p].push(e)};try{for(var d=(n=void 0,h(u.observerInfo[p])),y=d.next();!y.done;y=d.next())f(y.value)}catch(e){n={error:e}}finally{try{y&&!y.done&&(o=d.return)&&o.call(d)}finally{if(n)throw n.error}}}}}catch(e){t={error:e}}finally{try{c&&!c.done&&(r=i.return)&&r.call(i)}finally{if(t)throw t.error}}}(r.constructor);try{r.awake&&r.awake()}catch(e){console.error(r.constructor.systemName+" awake error",e)}return this.systems.push(r),r}console.warn(r.constructor.systemName+" System has been added")},t.prototype.removeSystem=function(e){if(e){var t=-1;"string"==typeof e?t=this.systems.findIndex((function(t){return t.name===e})):e instanceof Function?t=this.systems.findIndex((function(t){return t.constructor===e})):e instanceof D&&(t=this.systems.findIndex((function(t){return t===e}))),t>-1&&(this.systems[t].destroy&&this.systems[t].destroy(),this.systems.splice(t,1))}},t.prototype.getSystem=function(e){return this.systems.find((function(t){return"string"==typeof e?t.name===e:t instanceof e}))},t.prototype.pause=function(){!1!==this.playing&&(this.playing=!1,this.ticker.pause(),this.triggerPause())},t.prototype.start=function(){!0!==this.playing&&(this.ticker.start(),this.playing=!0,this.started=!0)},t.prototype.resume=function(){!0!==this.playing&&(this.ticker.start(),this.triggerResume(),this.playing=!0)},t.prototype.initTicker=function(){var e=this;this.ticker.add((function(t){var r,n,o,s;e.scene&&function(e,t){var r,n,o,s,a,i,c,u;void 0===t&&(t=[]);try{for(var p=h(t),l=p.next();!l.done;l=p.next()){var f=l.value;try{for(var d=(o=void 0,h(f.components)),m=d.next();!m.done;m=d.next()){var y=m.value;try{k(y),y.update&&y.update(e)}catch(e){console.error("gameObject: "+f.name+" "+y.name+" update error",e)}}}catch(e){o={error:e}}finally{try{m&&!m.done&&(s=d.return)&&s.call(d)}finally{if(o)throw o.error}}}}catch(e){r={error:e}}finally{try{l&&!l.done&&(n=p.return)&&n.call(p)}finally{if(r)throw r.error}}try{for(var v=h(t),g=v.next();!g.done;g=v.next()){f=g.value;try{for(var b=(c=void 0,h(f.components)),E=b.next();!E.done;E=b.next()){y=E.value;try{y.lateUpdate&&y.lateUpdate(e)}catch(e){console.error("gameObject: "+f.name+" "+y.name+" lateUpdate error",e)}}}catch(e){c={error:e}}finally{try{E&&!E.done&&(u=b.return)&&u.call(b)}finally{if(c)throw c.error}}}}catch(e){a={error:e}}finally{try{g&&!g.done&&(i=v.return)&&i.call(v)}finally{if(a)throw a.error}}}(t,e.gameObjects);try{for(var a=h(e.systems),i=a.next();!i.done;i=a.next()){var c=i.value;try{k(c),c.update&&c.update(t)}catch(t){console.error(c.constructor.systemName+" update error",t)}}}catch(e){r={error:e}}finally{try{i&&!i.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}try{for(var u=h(e.systems),p=u.next();!p.done;p=u.next()){c=p.value;try{c.lateUpdate&&c.lateUpdate(t)}catch(t){console.error(c.constructor.systemName+" lateUpdate error",t)}}}catch(e){o={error:e}}finally{try{p&&!p.done&&(s=u.return)&&s.call(u)}finally{if(o)throw o.error}}}))},t.prototype.triggerResume=function(){var e,t;!function(e){var t,r,n,o;try{for(var s=h(e),a=s.next();!a.done;a=s.next()){var i=a.value;try{for(var c=(n=void 0,h(i.components)),u=c.next();!u.done;u=c.next()){var p=u.value;try{p.onResume&&p.onResume()}catch(e){console.error("gameObject: "+i.name+", "+p.name+", onResume error",e)}}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=c.return)&&o.call(c)}finally{if(n)throw n.error}}}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}}(this.gameObjects);try{for(var r=h(this.systems),n=r.next();!n.done;n=r.next()){var o=n.value;try{o.onResume&&o.onResume()}catch(e){console.error(o.constructor.systemName+", onResume error",e)}}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}},t.prototype.triggerPause=function(){var e,t;!function(e){var t,r,n,o;try{for(var s=h(e),a=s.next();!a.done;a=s.next()){var i=a.value;try{for(var c=(n=void 0,h(i.components)),u=c.next();!u.done;u=c.next()){var p=u.value;try{p.onPause&&p.onPause()}catch(e){console.error("gameObject: "+i.name+", "+p.name+", onResume error",e)}}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=c.return)&&o.call(c)}finally{if(n)throw n.error}}}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}}(this.gameObjects);try{for(var r=h(this.systems),n=r.next();!n.done;n=r.next()){var o=n.value;try{o.onPause&&o.onPause()}catch(e){console.error(o.constructor.systemName+", onPause error",e)}}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}},t.prototype.destroySystems=function(){var e,t;try{for(var r=h(m(this.systems)),n=r.next();!n.done;n=r.next()){var o=n.value;this.removeSystem(o)}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}this.systems=[]},t.prototype.destroy=function(){this.removeAllListeners(),this.pause(),this.scene.destroy(),this.destroySystems(),this.ticker=null,this.scene=null,this.canvas=null,this.multiScenes=null},t.prototype.loadScene=function(e){var t=e.scene,r=e.mode,n=void 0===r?exports.LOAD_SCENE_MODE.SINGLE:r,o=e.params,s=void 0===o?{}:o;if(t){switch(n){case exports.LOAD_SCENE_MODE.SINGLE:this.scene=t;break;case exports.LOAD_SCENE_MODE.MULTI_CANVAS:this.multiScenes.push(t)}this.emit("sceneChanged",{scene:t,mode:n,params:s})}},t}(s.default);function V(e){return void 0===e&&(e={}),function(t){if(!t.observerInfo){for(var r in e)for(var n in e[r]){"string"==typeof e[r][n]&&(e[r][n]=[e[r][n]]);var o=void 0;Array.isArray(e[r][n])&&(o={prop:e[r][n],deep:!1},e[r][n]=o),"string"==typeof(o=e[r][n]).prop&&(o.prop=[o.prop])}t.observerInfo=e}}}var X,G,F=function(e){function t(t){var r=t.resource,n=t.resourceTotal,o=e.call(this)||this;return o.progress=0,o.resourceTotal=0,o.resourceLoadedCount=0,o.resource=r,o.resourceTotal=n,0===n&&o.resource.emit(exports.LOAD_EVENT.COMPLETE,o),o}return u(t,e),t.prototype.onStart=function(){this.resource.emit(exports.LOAD_EVENT.START,this)},t.prototype.onProgress=function(e){this.resourceLoadedCount++,this.progress=Math.floor(this.resourceLoadedCount/this.resourceTotal*100)/100,e.success?this.resource.emit(exports.LOAD_EVENT.LOADED,this,e):this.resource.emit(exports.LOAD_EVENT.ERROR,this,e),this.resource.emit(exports.LOAD_EVENT.PROGRESS,this,e),this.resourceLoadedCount===this.resourceTotal&&this.resource.emit(exports.LOAD_EVENT.COMPLETE,this)},t}(s.default);exports.LOAD_EVENT=void 0,(X=exports.LOAD_EVENT||(exports.LOAD_EVENT={})).START="start",X.PROGRESS="progress",X.LOADED="loaded",X.COMPLETE="complete",X.ERROR="error",exports.RESOURCE_TYPE=void 0,(G=exports.RESOURCE_TYPE||(exports.RESOURCE_TYPE={})).IMAGE="IMAGE",G.SPRITE="SPRITE",G.SPRITE_ANIMATION="SPRITE_ANIMATION",G.DRAGONBONE="DRAGONBONE",G.SPINE="SPINE",G.AUDIO="AUDIO",G.VIDEO="VIDEO",n.XhrLoadStrategy.setExtensionXhrType("json",n.XhrResponseType.Json),n.XhrLoadStrategy.setExtensionXhrType("tex",n.XhrResponseType.Json),n.XhrLoadStrategy.setExtensionXhrType("ske",n.XhrResponseType.Json),n.XhrLoadStrategy.setExtensionXhrType("mp3",n.XhrResponseType.Buffer),n.XhrLoadStrategy.setExtensionXhrType("wav",n.XhrResponseType.Buffer),n.XhrLoadStrategy.setExtensionXhrType("aac",n.XhrResponseType.Buffer),n.XhrLoadStrategy.setExtensionXhrType("ogg",n.XhrResponseType.Buffer);var U={png:n.ImageLoadStrategy,jpg:n.ImageLoadStrategy,jpeg:n.ImageLoadStrategy,webp:n.ImageLoadStrategy,json:n.XhrLoadStrategy,tex:n.XhrLoadStrategy,ske:n.XhrLoadStrategy,audio:n.XhrLoadStrategy,video:n.VideoLoadStrategy},B=new(function(e){function t(t){var r=e.call(this)||this;return r.timeout=6e3,r.resourcesMap={},r.makeInstanceFunctions={},r.destroyInstanceFunctions={},r.promiseMap={},r.loaders=[],t&&"number"==typeof t.timeout&&(r.timeout=t.timeout),r}return u(t,e),t.prototype.loadConfig=function(e){this.addResource(e),this.preload()},t.prototype.loadSingle=function(e){return this.addResource([e]),this.getResource(e.name)},t.prototype.addResource=function(e){var t,r;if(!e||e.length<1)console.warn("no resources");else try{for(var n=h(e),o=n.next();!o.done;o=n.next()){var s=o.value;this.resourcesMap[s.name]?console.warn(s.name+" was already added"):(this.resourcesMap[s.name]=s,this.resourcesMap[s.name].data={})}}catch(e){t={error:e}}finally{try{o&&!o.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}},t.prototype.preload=function(){var e=Object.values(this.resourcesMap).filter((function(e){return e.preload})).map((function(e){return e.name}));this.progress=new F({resource:this,resourceTotal:e.length}),this.loadResource({names:e,preload:!0})},t.prototype.getResource=function(e){return l(this,void 0,void 0,(function(){return f(this,(function(t){return this.loadResource({names:[e]}),[2,this.promiseMap[e]||Promise.resolve({})]}))}))},t.prototype.instance=function(e){return l(this,void 0,void 0,(function(){var t,r;return f(this,(function(n){switch(n.label){case 0:return t=this.resourcesMap[e],(r=this.makeInstanceFunctions[t.type])?[4,this.makeInstanceFunctions[t.type](t)]:[3,2];case 1:r=n.sent(),n.label=2;case 2:return[2,r]}}))}))},t.prototype.destroy=function(e){return l(this,void 0,void 0,(function(){return f(this,(function(t){switch(t.label){case 0:return[4,this._destroy(e)];case 1:return t.sent(),[2]}}))}))},t.prototype._destroy=function(e,t){return void 0===t&&(t=!1),l(this,void 0,void 0,(function(){var r,n;return f(this,(function(o){switch(o.label){case 0:if(!(r=this.resourcesMap[e]))return[2];if(t)return[3,5];o.label=1;case 1:return o.trys.push([1,4,,5]),this.destroyInstanceFunctions[r.type]?[4,this.destroyInstanceFunctions[r.type](r)]:[3,3];case 2:o.sent(),o.label=3;case 3:return[3,5];case 4:return n=o.sent(),console.warn("destroy resource "+r.name+" error with '"+n.message+"'"),[3,5];case 5:return delete this.promiseMap[e],r.complete=!1,r.instance=void 0,[2]}}))}))},t.prototype.registerInstance=function(e,t){this.makeInstanceFunctions[e]=t},t.prototype.registerDestroy=function(e,t){this.destroyInstanceFunctions[e]=t},t.prototype.loadResource=function(e){var t=this,r=e.names,n=void 0===r?[]:r,o=e.preload,s=void 0!==o&&o,a=n.filter((function(e){return!t.promiseMap[e]&&t.resourcesMap[e]}));if(a.length){var i={},c=this.getLoader(s);a.forEach((function(e){t.promiseMap[e]=new Promise((function(t){return i[e]=t}));var r=t.resourcesMap[e];for(var n in r.src){var o=r.src[n].type;"data"===o?(r.data[n]=r.src[n].data,t.doComplete(e,i[e],s)):c.add({url:r.src[n].url,name:r.name+"_"+n,strategy:U[o],metadata:{key:n,name:r.name,resolves:i}})}})),c.load()}},t.prototype.doComplete=function(e,t,r){return void 0===r&&(r=!1),l(this,void 0,void 0,(function(){var n,o,s,a;return f(this,(function(i){switch(i.label){case 0:if(n=this.resourcesMap[e],o={name:e,resource:this.resourcesMap[e],success:!0},!this.checkAllLoaded(e))return[3,4];i.label=1;case 1:return i.trys.push([1,3,,4]),s=n,[4,this.instance(e)];case 2:return s.instance=i.sent(),n.complete=!0,r&&this.progress.onProgress(o),t(n),[3,4];case 3:return a=i.sent(),n.complete=!1,r&&(o.errMsg=a.message,o.success=!1,this.progress.onProgress(o)),t({}),[3,4];case 4:return[2]}}))}))},t.prototype.checkAllLoaded=function(e){var t=this.resourcesMap[e];return Array.from(Object.keys(t.src)).every((function(e){return t.data[e]}))},t.prototype.getLoader=function(e){var t=this;void 0===e&&(e=!1);var r=this.loaders.find((function(e){return!e.loading}));return r||(r=new n.Loader,this.loaders.push(r)),e&&r.onStart.once((function(){t.progress.onStart()})),r.onLoad.add((function(r,n){t.onLoad({preload:e,resource:n})})),r.onError.add((function(r,n,o){t.onError({errMsg:r,resource:o,preload:e})})),r.onComplete.once((function(){r.onLoad.detachAll(),r.onError.detachAll(),r.reset()})),r},t.prototype.onLoad=function(e){var t=e.preload,r=void 0!==t&&t,n=e.resource;return l(this,void 0,void 0,(function(){var e,t,o,s,a;return f(this,(function(i){return e=n.metadata,t=e.key,o=e.name,s=e.resolves,a=n.data,this.resourcesMap[o].data[t]=a,this.doComplete(o,s[o],r),[2]}))}))},t.prototype.onError=function(e){var t=e.errMsg,r=e.preload,n=void 0!==r&&r,o=e.resource;return l(this,void 0,void 0,(function(){var e,r,s,a;return f(this,(function(i){return e=o.metadata,r=e.name,s=e.resolves,this._destroy(r,!0),s[r]({}),n&&(a={name:r,resource:this.resourcesMap[r],success:!1,errMsg:t},this.progress.onProgress(a)),[2]}))}))},t}(s.default)),q={IDEProp:T,componentObserver:V};exports.Component=v,exports.Game=M,exports.GameObject=C,exports.IDEProp=T,exports.Scene=A,exports.System=D,exports.Transform=R,exports.componentObserver=V,exports.decorators=q,exports.resource=B;
